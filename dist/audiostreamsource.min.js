/**
 * @license audiostreamsource.js 0.1.0 Copyright (c) 2015, Gregg Tavares All Rights Reserved.
 * Available via the MIT license.
 * see: http://github.com/greggman/audiostreamsource.js for details
 */
!function(a,b){"function"==typeof define&&define.amd&&define([],b),"undefined"!=typeof module&&module.exports?module.exports=b():a.audioStreamSource=b()}(this,function(){function a(a){var b={};return a.on=function(a,c){b[a]=c},emit=function(a){var c=b[a];c&&c.apply(null,Array.prototype.slice.call(arguments,1))}}function b(a,b){a()}function c(a){return"mic"===a}function d(a,b,c){h?setTimeout(function(){b(h)}):j.call(navigator,{audio:!0},function(c){h=a.createMediaStreamSource(c),b(h)},c)}function e(e){function f(a){return q=!1,l&&l.disconnect(),i()&&m.pause(),m&&(m.removeEventListener("error",s),m.removeEventListener("canplay",t),m.removeEventListener("ended",u),m=void 0),c(a)?void d(o,function(a){t(null,a)},s):(m=new Audio,m.loop=e.loop,m.autoplay=e.autoPlay,void 0!==e.crossOrigin&&(m.crossOrigin="anonymous"),m.addEventListener("error",s),m.addEventListener("canplay",t),m.addEventListener("ended",u),m.src=a,void m.load())}function g(){return l}function h(){r=!1,m&&(m.play(),m.currentTime=0)}function i(){return m&&!m.paused}function j(){return m?m.currentTime||0:0}function k(){return m?m.duration||0:0}console.log("using streaming audio");var l,m,n=a(this),o=e.context,p=e.autoPlay,q=!1,r=!1,s=function(a){n("error",a)},t=function(a,c){q||(q=!0,l&&(l.disconnect(),l=void 0),c?l=c:((p||r)&&b(h,n),l||(l=o.createMediaElementSource(m))),n("newSource",l))},u=function(){n("ended")};e.src&&f(e.src),this.isPlaying=i,this.play=function(){q?b(h,n):r=!0},this.stop=function(){m&&m.pause()},this.setSource=f,this.getSource=g,this.getDuration=k,this.getCurrentTime=j}function f(e){function f(){p=t.createBufferSource(),p.buffer=q,p.loop=u,r=!1}function g(){p&&p===h||q&&(r&&(f(),s("newSource",p)),r=!0,p.start(0),p.onended=m,y=Date.now(),x=!0)}function i(){p&&p===h||(p&&x&&(p.onended=void 0,p.stop(0),z=Date.now()),x=!1)}function j(){return x}function k(){return p&&p!==h?p.buffer.duration:0}function l(){if(p&&p!==h&&x){var a=.001*(Date.now()-y);return a%p.buffer.duration}return 0}function m(){s("ended")}function n(a,e){if(p&&(i(),p.disconnect(),p=void 0),c(a))return void d(t,function(a){p=a,s("newSource",a)},function(a){s("error",a)});var h=new XMLHttpRequest;h.open("GET",e||a,!0),h.responseType="arraybuffer",void 0!==w&&(h.withCredentials=!0),h.addEventListener("error",function(a){s("error",a)}),h.addEventListener("load",function(){t.decodeAudioData(h.response,function(a){q=a,f(),v&&b(g,s),s("newSource",p)})}),h.send()}function o(){return p}console.log("using NON-streaming audio");var p,q,r,s=a(this),t=e.context,u=e.loop,v=e.autoPlay,w=e.crossOrigin,x=!1,y=Date.now(),z=Date.now();e.src&&n(e.src,e.lofiSrc),this.getSource=o,this.setSource=n,this.play=g,this.stop=i,this.isPlaying=j,this.getDuration=k,this.getCurrentTime=l}function g(a){return new(i?f:e)(a)}var h,i=/Android|iPhone|iPad|iPod/.test(navigator.userAgent),j=(/^((?!chrome|android).)*safari/i.test(navigator.userAgent),navigator.getUserMedia||navigator.webkitGetUserMedia);return{create:g}});